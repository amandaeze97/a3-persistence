<!doctype html>
<html lang="en">
  <head>
    <title>Restaurant</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link href="/css/style.css" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Lobster+Two|Raleway&display=swap" rel="stylesheet">
  </head>
  
  <body>
    <div class="container">
      
      <header>
        <img src="https://cdn.glitch.com/43008e21-b00d-4a43-831e-9d38ee279bc0%2Frice_bowl_header.jpg?v=1568002875243" id="rice-bowl" alt="4 bowls of different toppings">
        <div class="img-text">
          <h1>Bon Me</h1>
          <h2>Create your own rice bowl!</h2>
          
          <div class="navigationPane">
            <nav class="links">
              <a><button id="form-link" aria-label="link to order form">Place an Order</button></a>
              <a><button id="table-link" aria-label="link to list of orders">View Orders</button></a>
            </nav>
          </div>
        </div>
      </header>
      
      <main>
        <div id="error-msg">
          <i class="fa  fa-exclamation-circle"></i>
          Fill in all the required fields.
        </div>
        
        <!-- PLACE AN ORDER -->
        <div id="order-form">
          <h3>Rice Bowls</h3>
          <form action="/">
            <div class="form-input">
              <label for="fst-name" class="form-label"> First Name</label>
              <input type="text" id="fst-name" required>
              
              <br><br>
              
              <label for="lst-name" class="form-label"> Last Name</label>
              <input type="text" id="lst-name" required>
            </div>

            <div class="form-input text-input">
              <label for="order-name" class="form-label">Name of your Order</label>
              <input type="text" id="order-name" required>
            </div><br>
            
            <p> 
              <b>REGULAR</b> Your choice of grain and protein with toasted sesame sauce, pickled carrots, daikon, mesclun, cilantro, scallions, & crispy shallots.
            </p>

            <div class="form-input" role="radiogroup" aria-label="type-of-grain">
              <b><p class="form-label" id="grain">Grain</p></b>
              
              <input type="radio" role="radio" checked id="brown_rice" name="grain" value="0">             
              <label for="brown_rice">Brown Rice</label><br>
              
              <input type="radio" role="radio" id="wh[te_rice" name="grain" value="0">
              <label for="white_rice">White Rice</label><br>
              
              <input type="radio" role="radio" id="quinoa_brown_rice" name="grain" value="1">
              <label for="quinoa_brown_rice">Quinoa & Brown Rice</label><br>
            </div><br>

            <div class="form-input" role="radiogroup" aria-label="type-of-protein">
              <b><p class="form-label">Protein</p></b>
              
              <input type="radio" role="radio" checked id="salt_pepper_chk" name="protein" value="1">
              <label for="salt_pepper_chk">Chinese Salt + Pepper Chicken</label><br>
              
              <input type="radio" role="radio" id="tamari_chk" name="protein" value="2">
              <label for="tamari_chk">Tamari Chicken</label><br>
              
              <input type="radio" role="radio" id="char_siu_bbq_chk" name="protein" value="1">
              <label for="char_siu_bbq_chk">Char Siu BBQ Chicken</label><br>
              
              <input type="radio" role="radio" id="gochujang_chk" name="protein" value="1">
              <label for="gochujang_chk">Gochujang Chicken</label><br>
              
              <input type="radio" role="radio" id="miso_braised_pulled_pork" name="protein" value="1">
              <label for="miso_braised_pulled_pork">Miso Braised Pulled Pork</label><br>
              
              <input type="radio" role="radio" id="fiery_chickpeas" name="protein" value="1">
              <label for="fiery_chickpeas">Fiery Chickpeas</label><br>
              
              <input type="radio" role="radio" id="roasted_paprika_tofu" name="protein" value="1">
              <label for="roasted_paprika_tofu">Roasted Paprika Tofu</label><br>
            </div>
            
            <div id="submit-btn"><button>Place Order</button></div>
          </form>
        </div>
        
        <!-- ORDER CONFIRMATION -->
        <div id="order-confirmation">
          <h3>Your order has been successfully placed!</h3><br>
          <button id="orders-btn">View Orders</button>
        </div>
        
        <!-- LIST OF ORDERS -->
        <div id="order-table" style=" margin-left: -20%;">
          <h3>Rice Bowl Orders</h3>
          <table id="orders"></table>
        </div>
        
        <!-- UPDATE ORDER FORM -->
        <div id="update-order-form">
          <h3>Update Your Order</h3>
          <form action="/">
            <div class="form-input">
              <label for="updateFstName" class="form-label">First Name</label>
              <input type="text" id="updateFstName" required>
            </div>
            
            <div class="form-input">
              <label for="updateLstName" class="form-label">Last Name</label>
              <input type="text" id="updateLstName" required>
            </div>

            <div class="form-input">
              <label for="updateOrderName" class="form-label">Name of your order</label>
              <input type="text" id="updateOrderName" required>
            </div>
            
            <div class="form-input" role="radiogroup" aria-label="type-of-grain">
              <b><p class="form-label" id="updateGrain">Rice Bowl - Grain</p></b>
              
              <input type="radio" role="radio" checked id="update_brown_rice" name="updateGrain" value="0">             
              <label for="update_brown_rice">Brown Rice</label><br>
              
              <input type="radio" role="radio" id="update_white_rice" name="updateGrain" value="0">
              <label for="update_white_rice">White Rice</label><br>
              
              <input type="radio" role="radio" id="update_quinoa_brown_rice" name="updateGrain" value="1">
              <label for="update_quinoa_brown_rice">Quinoa & Brown Rice</label><br>
            </div>
            
            <div class="form-input" role="radiogroup" aria-label="type-of-protein">
              <b><p class="form-label">Protein</p></b>
              
              <input type="radio" role="radio" checked id="update_salt_pepper_chk" name="updateProtein" value="1">
              <label for="update_salt_pepper_chk">Chinese Salt + Pepper Chicken</label><br>
              
              <input type="radio" role="radio" id="update_tamari_chk" name="updateProtein" value="2">
              <label for="update_tamari_chk">Tamari Chicken</label><br>
              
              <input type="radio" role="radio" id="update_char_siu_bbq_chk" name="updateProtein" value="1">
              <label for="update_char_siu_bbq_chk">Char Siu BBQ Chicken</label><br>
              
              <input type="radio" role="radio" id="update_gochujang_chk" name="updateProtein" value="1">
              <label for="update_gochujang_chk">Gochujang Chicken</label><br>
              
              <input type="radio" role="radio" id="update_miso_braised_pulled_pork" name="updateProtein" value="1">
              <label for="update_miso_braised_pulled_pork">Miso Braised Pulled Pork</label><br>
              
              <input type="radio" role="radio" id="update_fiery_chickpeas" name="updateProtein" value="1">
              <label for="update_fiery_chickpeas">Fiery Chickpeas</label><br>
              
              <input type="radio" role="radio" id="update_roasted_paprika_tofu" name="updateProtein" value="1">
              <label for="update_roasted_paprika_tofu">Roasted Paprika Tofu</label><br>
            </div>
            
            <div id="update-form-btns">
              <button id="cancel-btn">Cancel</button>
              <button id="update-btn">Update Order</button>
            </div>
          </form>
        </div>
      </main>
    </div>
  </body>

  <script>
    const addOrder = function( e ) {
      e.preventDefault();
      
      const newOrder = {
        fstname: document.getElementById( 'fst-name' ).value,
        lstname: document.getElementById( 'lst-name' ).value,
        ordername: document.getElementById( 'order-name' ).value,
        typeOfGrain: document.querySelector('input[name="grain"]:checked').value,
        typeOfProtein: document.querySelector('input[name="protein"]:checked').value
      };
      
      if (orderValidation(newOrder.fstname, newOrder.lstname, newOrder.ordername)) {
        const body = JSON.stringify( newOrder );
        fetch( '/submit', {
          method:'POST',
          body
        }).then( function( response ) {
          document.getElementById('order-confirmation').style.display = "flex";
          document.getElementById('order-form').style.display = "none";
          resetOrderForm();
        });
      }
      return false;
    };
    
    const deleteOrder = function (index) {
      const orderNumber = { orderNumber: index };
      const body = JSON.stringify(orderNumber);
      fetch('/delete', {
        method: 'POST',
        body
      });
      fetchOrders();
    };
    
    const fetchOrders = async function() {
      try {
        const resp = await fetch('/orders', { method: 'GET' });
        const data = await resp.json();
        const orders = data.data;
        let htmlDiv = document.getElementById('orders');
        htmlDiv.innerHTML = '<tr>\n' +
                '              <th>First Name</th>\n' +
                '              <th>Last Name</th>\n' +
                '              <th>Order Name</th>\n' +
                '              <th>Grain</th>\n' +
                '              <th>Protein</th>\n' +
                '              <th>Price</th>\n' +
                '              <th></th>\n' +
                '              <th></th>\n' +
                '            </tr>';
        
        for (let i = 0; i < orders.length; i++) {
          const order = orders[i];
          const stringOrder = JSON.stringify(orders[i]);
          let newRow = '<tr>\n';
          newRow += (`<td> ${order.fstname} </td>\n`);
          newRow += (`<td> ${order.lstname} </td>\n`);
          newRow += (`<td> ${order.ordername} </td>\n`);
          newRow += (`<td> ${order.typeOfGrain} </td>\n`);
          newRow += (`<td> ${order.typeOfProtein} </td>\n`);
          newRow += (`<td> ${"$" + order.price} </td>\n`);
          newRow += (`<td> <button id="update-button-${i}" class="table-button" style="font-size: 1vw" onclick="viewUpdateForm(${i})" data-string=` + encodeURIComponent(stringOrder) + `>Modify</button> </td>\n`);
          newRow += (`<td> <button id="delete-button-${i}" class="table-button" style="font-size: 1vw" onclick="deleteOrder(${i})">Delete</button> </td>\n`);
          newRow += '</tr>';
          htmlDiv.innerHTML += newRow;
        }
      } catch (err) {
        console.log(err);
      }
      return false;
    };
    
    const updateOrder = ( e ) => {
      e.preventDefault();
      
      const updatedOrder = {
        index: document.getElementById('update-btn').dataset.index,
        fstname: document.getElementById('updateFstName').value,
        lstname: document.getElementById('updateLstName').value,
        ordername: document.getElementById('updateOrderName').value,
        typeOfGrain: document.querySelector('input[name="updateGrain"]:checked').value,
        typeOfProtein: document.querySelector('input[name="updateProtein"]:checked').value
      };
      
      if (orderValidation(updatedOrder.fstname, updatedOrder.lstname, updatedOrder.ordername)) {
        const body = JSON.stringify(updatedOrder);
        fetch('/update', {
          method: 'POST',
          body
        }).then(function () {
          viewOrderTable();
        });
      }
      return false;
    };
    
    const resetOrderForm = () => {
      document.getElementById('fst-name').value = '';
      document.getElementById('lst-name').value = '';
      document.getElementById('order-name').value = '';
      document.getElementById('brown_rice').checked = true;
      document.getElementById('salt_pepper_chk').checked = true;
    };
    
    const orderValidation = function (fstname, lstname, ordername) {
      if (fstname === '' || lstname === '') {
        document.getElementById('error-msg').style.display = "block";
        document.getElementById('error-msg').focus();
        return false;
      } else if (ordername === '') {
        document.getElementById('error-msg').style.display = "block";
        document.getElementById('error-msg').focus();
        return false;
      } else {
        document.getElementById('error-msg').style.display = "none";
        return true;
      }
    };
    
    const viewOrderForm = function() {
      document.getElementById('error-msg').style.display = "none";
      document.getElementById('order-table').style.display = "none";
      document.getElementById('update-order-form').style.display = "none";
      document.getElementById('order-confirmation').style.display = "none";
      document.getElementById('order-form').style.display = "block";
      resetOrderForm();
    };
    
    const viewOrderTable  = function () {
      document.getElementById('order-table').style.display = "flex";
      document.getElementById('order-form').style.display = "none";
      document.getElementById('update-order-form').style.display = "none";
      document.getElementById('order-confirmation').style.display = "none";
      document.getElementById('error-msg').style.display = "none";
      fetchOrders();
      return false;
    };
    
    const viewUpdateForm = function (index) {
      let orderToUpdate = decodeURIComponent(document.getElementById(`update-button-${index}`).dataset.string);
      orderToUpdate = JSON.parse(orderToUpdate);
      
      document.getElementById('order-table').style.display = "none";
      document.getElementById('update-order-form').style.display="block";
      
      // load values
      document.getElementById('update-btn').dataset.index = index;
      document.getElementById('updateFstName').value=orderToUpdate.fstname;
      document.getElementById('updateLstName').value=orderToUpdate.lstname;
      document.getElementById('updateOrderName').value=orderToUpdate.ordername;
      
      orderToUpdate.typeOfGrain === 3 ? document.getElementById('update_brown_rice').checked = true : document.getElementById('update_white_rice').checked = true;
      orderToUpdate.typeOfProtein ? document.getElementById('update_salt_pepper_chk').checked = true : document.getElementById('update_fiery_chickpeas').checked = true;
      return false;
    };
    
    window.onload = function() {
      const submitButton = document.getElementById( 'submit-btn' );
      submitButton.onclick = addOrder;
      const tableLink = document.getElementById( 'table-link' );
      tableLink.onclick = viewOrderTable;
      const formLink = document.getElementById( 'form-link' );
      formLink.onclick = viewOrderForm;
      const cancelButton = document.getElementById( 'cancel-btn' );
      cancelButton.onclick = viewOrderTable;
      const updateButton = document.getElementById( 'update-btn' );
      updateButton.onclick = updateOrder;
      const ordersButton = document.getElementById( 'orders-btn' );
      ordersButton.onclick = viewOrderTable;
    };
  </script>
</html>